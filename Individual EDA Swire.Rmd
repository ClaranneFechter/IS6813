---
title: "Individual EDA Swire"
author: "Claranne Fechter"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
---

# Introduction

Swire Coca-Cola has begun the use of its new digital ordering platform, MyCoke360, and it has been running for a little over a year. Cart abandonment is something all businesses have to worry about, and Swire is no different. In this context, cart abandonment is described as when a customer adds items to their cart, but does not make a purchase before their next order date. This abandonment can lead to a loss in revenue. Swire has tasked us with identifying what tends to influence a customer to abandon their carts. The purpose of this notebook is to gain insight about each dataset, specifically the google analytics, sales, and orders data. We want to investigate what variables could influence customers and what actions they take within their carts.

# Libraries and Loading

```{r}
library(tidyverse)
library(dplyr)
library(skimr)
library(ggplot2)
library(janitor)
library(lubridate)

visitplan <- read.csv("visit_plan.csv")
google <- read.csv("google_analytics.csv")
orders <- read.csv("orders.csv")
customer <- read.csv("customer.csv")
sales <- read.csv("sales.csv")
material <- read.csv("material.csv")
hours <- read.csv("operating_hours.csv")
cutoff <- read.csv("cutoff_times.csv")
```


# Data Description

For this project, we have access to 8 datasets in total. The google analytics data contains specific actions taken by the customers on the website. Orders provide us with any orders that were made. Sales contain data of what was actually sold to customers. The visit plan set helps us determine their policy and when they are scheduled to order. The last four datasets are customers, materials, cutoff times, and operating hours. These datasets give us further information about the customer, their policy, and products. Most of the datasets are quite large, with visit plan containing 14 million rows and the smallest being cutoff times with only 220 rows. With all of this data, we will have to do some feature engineering because the target variable has not been defined. The abandoned cart, for this project, is determined by a specific time when the next order must be placed again. We will have to create this order window in order to correctly show cart abandonment. 

# GA Cleaning

```{r}
skim(google)
google_clean <- google |>
  mutate(event_timestamp_EST = ymd_hms(EVENT_TIMESTAMP, tz = "US/Eastern"),
         event_date = as.Date(EVENT_DATE))
unique(google_clean$EVENT_NAME)
google_clean |> count(EVENT_NAME, sort = TRUE)

#Add new column to group events into more comprehendible names to focus on what matters
google_clean <- google_clean |>
  mutate(event_grouped = case_when(
    
    EVENT_NAME %in% c("AccountSelect_SwitchAccount_Clicked","AccountSelect_SwitchAccount_Completed",
                      "Close_SwitchAccount_Clicked","login","Login_Cancelled","Login_Clicked",
                      "Login_Home_Page_Displayed","logout","Logout_Profile_Clicked",
                      "SwitchAccountPopup_Dispayed") ~ "Account",
    
    EVENT_NAME %in% c("Account_Pressed_Failed","Get_Account_Details_Failed",
                      "Get_Account_Easy_Order_Failed","Get_Delegated_Account_Failed",
                      "Is_Account_Blocked_For_Ordering_Failed","Logout_Profile_Failed",
                      "SSO_Token_Details_Failed",
                      "Get_User_Details_From_User_Id_Failed") ~ "Account_Failed",
    
    EVENT_NAME %in% c("add_to_cart","CartPage_Displayed","CartProductQuantity_Cart_Changed",
                      "ContinueShopping_Cart_Clicked","export_cart_click",
                      "ProductAddtoCart_PDP_Clicked","ProductAddtoCart_PLP_Clicked",
                      "ProductCheckmark_Cart_Checked","ProductCheckmark_Cart_Unchecked",
                      "ProductSelected_Cart_Clicked","remove_from_cart","SelectAll_Cart_Checked",
                      "SelectAll_Cart_Unchecked","update_cart","UpdateCart_Cart_Clicked",
                      "UpdateCart_Cart_Retrieved","view_cart") ~ "Cart",
    
    EVENT_NAME %in% c("CartProducts_Cart_Retrieve_Failed","Handle_Add_To_Cart_Failed",
                      "ProductAddtoCart_PLP_Failed","Update_Cart_Details_For_Payment_Failed",
                      "Update_Cart_Item_With_Price_Data_Failed","Update_Cart_With_Details_Failed",
                      "Update_Web_Cart_Failed","Error_Get_cart_data","Error_get_webcart_details",
                      "Get_Active_Cart_Items_Failed","Get_Cart_Count_Failed",
                      "Get_Product_Quantity_In_Cart_Failed") ~ "Cart_Failed",
    
    EVENT_NAME %in% c("add_payment_info","add_shipping_info","begin_checkout",
                      "proceed_to_checkout","CheckoutPage_Displayed",
                      "CheckoutData_CheckoutPage_Retrieved") ~ "Checkout",
    
    EVENT_NAME %in% c("OrderSuccessPage_Displayed","purchase") ~ "Purchase",
    
    EVENT_NAME %in% c("On_Proceed_To_Checkout_Click_Failed","OrderSubmit_CheckoutPage_Failed",
                      "Process_Payment_Error","Payment_API_Failed","Error_Handle_Payment_Method",
                      "Get_Payment_Methods_Data_Failed","Get_Payment_Method_Failed",
                      "Get_SnapPay_Mapping_MetaData_Failed","CheckoutData_Retrieve_Failed",
                      "cancel_order") ~ "Checkout_Failed",
    
    EVENT_NAME %in% c("Categories_PLP_Retrieved","filter_by","Images_PDP_Reteieved",
                      "ProductCount_PDP","ProductCount_PLP","ProductsList_PLP_Retrieved",
                      "select_item","select_promotion","sort_by","view_item","view_item_list",
                      "view_promotion","view_search_results",
                      "view_site_search") ~ "Item",
    
    EVENT_NAME %in% c("Images_PDP_Reteieve_Failed","ProductsList_PLP_Retrieve_Failed",
                      "Get_Assortment_Product_List_Failed",
                      "Get_Filter_Options_Failed") ~ "Item_Failed",
    
    EVENT_NAME %in% c("InvoiceList_InvoiceTab_Retrieved","InvoiceListFilter_InvoiceTab_Successfull",
                      "OrderTab_Displayed","pay_invoice_click",
                      "RecentPayedInvoice_InvoiceTab_Clicked","search_invoice",
                      "search_order_history") ~ "Orders_Invoices",
    
    EVENT_NAME %in% c("Check_Prod_For_AML_And_Inventory_Failed","Get_Delivery_Dates_Api_Failed",
                      "Get_Invoice_Data_Failed","Get_Invoice_Details_Failed",
                      "Get_Oct_Invoice_Failed","Get_Order_History_Failed",
                      "Get_Order_History_Filter_Options_Failed","Get_Recent_Order_Data_Failed",
                      "InvoiceList_InvoiceTab_Retrieve_Failed","Create_Delivery_Quantity_Failed",
                      "Error_Delivery_Method",
                      "Delete_Order_History_Cache_Failed","refund") ~ "Orders_Invoices_Failed",
    
    EVENT_NAME %in% c("BackClicked_CST","CloseTicket_EST_Clicked","CloseTicket_EST_Successful",
                      "create_ticket","SupportTab_Displayed","Ticked_CST_Clicked",
                      "Ticked_EST_Clicked","Ticket_CST_Displayed","Ticket_EST_Displayed",
                      "TicketList_CST_Retrieved","TicketList_EST_Retrieved",
                      "TicketListFilter_CST_Successfull","TicketListFilter_EST_Successfull",
                      "TicketSearch_CST_Clicked","TicketSearch_EST_Clicked") ~ "Tickets",
    
    EVENT_NAME %in% c("Post_Create_ESTCST_Ticket_Failed","TicketList_CST_Retrieve_Failed",
                      "TicketList_EST_Retrieve_Failed") ~ "Tickets_Failed",
    
     EVENT_NAME %in% c("application_launched","app_remove","app_update","BackClicked_PDP",
                      "button_click","Close_Profile_Clicked","homepage_register_now",
                      "nav_link_click","page_view","ProfilePopup_Displayed","screen_view",
                      "session_start","user_engagement","first_visit") ~ "Engagement",
    
     EVENT_NAME %in% c("Get_Banner_Images_Dashboard_Count","Get_Banner_Images_Plp_Count",
                      "Get_Banner_Images_Time_Comparison",
                      "Maintenance_Flag_Successful","os_update") ~ "Other_Success",
    
    EVENT_NAME %in% c("AML_Validation_Failed","Error_post_create_webcart",
                      "Error_Updating_Session_Delivery","Fetch_Menu_Access_Failed",
                      "Get_Banner_Images_Failed","Get_Bottler_Meta_Data_Failed",
                      "Get_Web_Store_Failed","Handle_Auth_Success_Failed",
                      "handle_save_azure_key_failed","Get_Is_Dom_Enabled_Failed",
                      "Get_Decision_Tree_Data_Failed") ~ "Other_Failed",
    
    TRUE ~ "Other"
  ))

unique(google_clean$event_grouped)
```

# GA Visuals

```{r}
event_summary <- google_clean |>
  count(event_grouped, sort = TRUE) |>
  mutate(percent = round(n / sum(n) * 100, 2))
event_summary

ggplot(event_summary, aes(x = reorder(event_grouped, -n), y = n, fill = event_grouped)) +
  geom_col() +
  geom_text(aes(label = paste0(percent, "%")),
            vjust = -0.5, size = 3) +
  labs(title = "Distribution of Event Groups",
       x = "Event Group",
       y = "Count of Events") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")
```

```{r}
#Count of event by device
ggplot(google_clean, aes(x = event_grouped, fill = DEVICE_CATEGORY)) +
  geom_bar(stat = "count", position = "dodge") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Grouped Events", y = "Count", fill = "Device Category")

#Proportion of event by device
google_clean %>%
  group_by(DEVICE_CATEGORY, event_grouped) %>%
  summarise(count = n()) %>%
  group_by(DEVICE_CATEGORY) %>%
  mutate(prop = count / sum(count)) %>%
  ggplot(aes(x = event_grouped, y = prop, fill = DEVICE_CATEGORY)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
#Common events that happen each day
google_clean_daily <- google_clean |>
  group_by(event_date, event_grouped) |>
  summarise(count = n(), .groups = "drop")

ggplot(google_clean_daily, aes(x = event_date, y = count, fill = event_grouped)) +
  geom_col() +
  labs(title = "Daily Events by Group",
       x = "Date",
       y = "Number of Events",
       fill = "Event Group") +
  theme_minimal()
```

```{r}
#See events that should lead into each other
funnel_google_clean <- google_clean |>
  group_by(event_grouped) |>
  summarise(users = n_distinct(CUSTOMER_ID), .groups = "drop") |>
  filter(event_grouped %in% c("Engagement", "Item", "Cart", "Checkout", "Purchase")) |>
  mutate(event_grouped = factor(event_grouped, 
                                levels = c("Engagement", "Item", "Cart", "Checkout", "Purchase")))
ggplot(funnel_google_clean, aes(x = event_grouped, y = users)) +
  geom_col(fill = "lightblue") +
  geom_text(aes(label = users), vjust = -0.5) +
  labs(title = "User Funnel",
       x = "Stage",
       y = "Unique Users") +
  theme_minimal()
```

```{r}
#Events that lead to a purchase but no purchase was made/checkout failed
funnel_google_clea_2 <- google_clean |>
  group_by(event_grouped) |>
  summarise(users = n_distinct(CUSTOMER_ID), .groups = "drop") |>
  filter(event_grouped %in% c("Engagement", "Item", "Cart", "Checkout", "Checkout_Failed")) |>
  mutate(event_grouped = factor(event_grouped, 
                                levels = c("Engagement", "Item", "Cart", "Checkout", "Checkout_Failed")))

ggplot(funnel_google_clea_2, aes(x = event_grouped, y = users)) +
  geom_col(fill = "pink") +
  geom_text(aes(label = users), vjust = -0.5) +
  labs(title = "User Funnel",
       x = "Stage",
       y = "Unique Users") +
  theme_minimal()
```

# Oders Cleaning

```{r}
skim(orders)
orders_clean <- orders %>%
  mutate(CREATED_DATE_EST = as.Date(CREATED_DATE_EST),
         CREATED_DATE_UTC = lubridate::ymd_hms(CREATED_DATE_UTC, tz = "UTC"))

orders_clean <- orders_clean %>%
  mutate(order_purchased = if_else(ORDER_QUANTITY == 0, "No Purchase", "Purchased", missing = "No Purchase"))

summary(orders_clean)
summary(orders_clean$order_purchased)
table(orders_clean$order_purchased)
```

# Orders Visuals

```{r}
#Look at only no purchase/no order quantity
no_purchase_orders <- orders_clean %>%
  filter(order_purchased == "No Purchase")

no_purchase_orders %>%
  group_by(CREATED_DATE_EST) %>%
  summarise(count = n(), .groups = "drop") %>%
  ggplot(aes(x = CREATED_DATE_EST, y = count)) +
  geom_line(color = "red") +
  labs(title = "No Purchase Orders Over Time",
       x = "Date",
       y = "Number of No Purchase Orders") +
  theme_minimal()
```

```{r}
#No order quantity by order type
no_purchase_orders %>%
  count(ORDER_TYPE) %>%
  ggplot(aes(x = ORDER_TYPE, y = n, fill = ORDER_TYPE)) +
  geom_col() +
  geom_text(aes(label = n), vjust = -0.5) +
  labs(title = "No Purchase Orders by Type",
       x = "Order Type",
       y = "Count") +
  theme_minimal()
```

```{r}
#No order quantity by plant
no_purchase_orders %>%
  count(PLANT_ID) %>%
  ggplot(aes(x = as.factor(PLANT_ID), y = n, fill = as.factor(PLANT_ID))) +
  geom_col() +
  geom_text(aes(label = n), vjust = -0.5) +
  labs(title = "No Purchase Orders by Plant",
       x = "Plant ID",
       y = "Count") +
  theme_minimal()
```

# Visitplan Cleaning

```{r}
skim(visitplan)
visitplan_clean <- visitplan %>%
  mutate(ELT_TS = ymd_hms(ELT_TS),
         DISTRIBUTION_MODE = ifelse(is.na(DISTRIBUTION_MODE) | DISTRIBUTION_MODE == ""| DISTRIBUTION_MODE == "null", "Unknown", DISTRIBUTION_MODE),
         SALES_OFFICE_DESC = ifelse(is.na(SALES_OFFICE_DESC) | SALES_OFFICE_DESC == ""| SALES_OFFICE_DESC == "null", "Unknown", SALES_OFFICE_DESC),
         SALES_OFFICE = ifelse(is.na(SALES_OFFICE) | SALES_OFFICE == ""| SALES_OFFICE == "null", "Unknown", SALES_OFFICE),
         SNAPSHOT_DATE = ymd(SNAPSHOT_DATE),
         ANCHOR_DATE = ymd(ANCHOR_DATE),
         SNAPSHOT_MONTH = floor_date(SNAPSHOT_DATE, unit = "month"),
         ANCHOR_MONTH = floor_date(ANCHOR_DATE, unit = "month"))

summary(visitplan_clean)
unique(visitplan_clean$SALES_OFFICE_DESC)
visitplan_clean %>%
  count(DISTRIBUTION_MODE) %>%
  arrange(desc(n))
```

# Vistplan Visuals

```{r}
#Distribution of frequency
visitplan_clean %>%
  ggplot(aes(x = FREQUENCY)) +
  geom_bar(fill = "steelblue") +
  labs(title = "Distribution of Visit Frequencies", x = "Frequency", y = "Count") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")
```

```{r}
#Number of visits by sales office
visitplan_clean %>%
  count(SALES_OFFICE_DESC) %>%
  ggplot(aes(x = reorder(SALES_OFFICE_DESC, n), y = n)) +
  geom_col(fill = "darkgreen") +
  coord_flip() +
  labs(title = "Visits by Sales Office", x = "Sales Office", y = "Count")
```

# Sales Cleaning

```{r}
skim(sales)
sales_clean <- sales %>%
  mutate(POSTING_DATE = mdy(POSTING_DATE))
sales_clean %>% summarise(
  neg_profit = sum(GROSS_PROFIT_DEAD_NET < 0),
  neg_nsi = sum(NSI_DEAD_NET < 0)
)
#Make column to show negatives
sales_clean <- sales_clean %>%
  mutate(gross_profit_neg = if_else(GROSS_PROFIT_DEAD_NET < 0, "Negative", "Positive"),
         nsi_neg = if_else(NSI_DEAD_NET < 0, "Negative", "Positive"))

summary(sales_clean)
```

# Sales Visuals

```{r}
#Sales over time
sales_clean %>%
  group_by(month = floor_date(POSTING_DATE, "month")) %>%
  summarise(total_sales = sum(NSI_DEAD_NET), .groups = "drop") %>%
  ggplot(aes(x = month, y = total_sales)) +
  geom_line(color = "darkgreen", size = 1) +
  labs(title = "Sales Trend Over Time",
       x = "Month", y = "Total Sales") +
  theme_minimal()
```

```{r}
#Top customers
sales_clean %>%
  group_by(CUSTOMER_ID) %>%
  summarise(total_sales = sum(NSI_DEAD_NET)) %>%
  slice_max(total_sales, n = 10) %>%
  ggplot(aes(x = reorder(CUSTOMER_ID, total_sales), y = total_sales)) +
  geom_col(fill = "darkorange") +
  coord_flip() +
  labs(title = "Top 10 Customers by Sales",
       x = "Customer", y = "Total Sales")
```

```{r}
#Customers with negatives
sales_clean %>% 
  filter(nsi_neg == "Negative") %>%
  count(CUSTOMER_ID, sort = TRUE)
#Materials that have negatives
sales_clean %>% 
  filter(nsi_neg == "Negative") %>%
  count(MATERIAL_ID, sort = TRUE)
#Negatives over time
sales_clean %>% 
  filter(nsi_neg == "Negative") %>%
  group_by(month = floor_date(POSTING_DATE, "month")) %>%
  summarize(negative_sales = n()) %>%
  ggplot(aes(x = month, y = negative_sales)) +
  geom_line(color = "red") +
  labs(title = "Trend of Negative Profits Over Time")
```

# Other CLeaning

```{r}
customer_clean <- customer %>%
  mutate(CUSTOMER_NUMBER = as.character(CUSTOMER_NUMBER))

material_clean <- material %>%
  mutate(MATERIAL_ID = as.character(MATERIAL_ID))

hours_clean <- hours %>%
  mutate(CALLING_ANCHOR_DATE = mdy(CALLING_ANCHOR_DATE),
         CUSTOMER_NUMBER = as.character(CUSTOMER_NUMBER))

cutoff_clean <- cutoff %>%
  mutate(CUTOFFTIME__C = hms(CUTOFFTIME__C))
```

